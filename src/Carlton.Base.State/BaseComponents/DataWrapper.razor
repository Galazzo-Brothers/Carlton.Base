@namespace Carlton.Base.State
@implements IDataWrapper
@implements IDisposable
@typeparam TViewModel
@typeparam TStateEvents where TStateEvents : Enum
@inject IDataComponent<TViewModel> Component
@inject IMediator Mediatr
@inject IStateStore<TStateEvents> StateStore
@inject ILogger<DataWrapper<TViewModel, TStateEvents>> Logger

<DynamicComponent Type="WrappedComponentType" Parameters="GetParameters()" />


@code {
    public Object State { get => StateStore; }

    public Type WrappedComponentType { get => Component.GetType(); }

    public string WrappedComponentDisplayName { get => WrappedComponentType.GetDisplayName(); }

    public TViewModel ViewModel { get; private set; }

    public IEnumerable<TStateEvents> ObserveableStateEvents { get; private set; } = new List<TStateEvents> { };

    protected async override Task OnInitializedAsync()
    {
        //Register State Changed Handler
        StateStore.StateChanged += OnStateChanged;

        //Get VM and initalize context for wrapped component
        ViewModel = await GetViewModelInternal();

        //Gather the StateEvents this component should be listening for
        var attributes = (IEnumerable<ObserveStateEventsAttribute<TStateEvents>>)WrappedComponentType.GetCustomAttributes(typeof(ObserveStateEventsAttribute<TStateEvents>));
        ObserveableStateEvents = attributes.SelectMany(_ => _.StateEvents);

        //Continue initilization
        await base.OnInitializedAsync();
    }

    private async Task<TViewModel> GetViewModelInternal()
    {
        var request = new ViewModelRequest<TViewModel>(this);
        return await GetViewModel(request);
    }

    protected async virtual Task<TViewModel> GetViewModel(ViewModelRequest<TViewModel> request)
    {
        return await Mediatr.Send(request);
    }

    protected async Task OnComponentEventInternal<TCommand>(object sender, TCommand command)
        where TCommand : ICommand
    {
        var commandType = command.GetType();
        var request = (dynamic) Activator.CreateInstance(typeof(CommandRequest<>).MakeGenericType(command.GetType()), this, command);
        await OnComponentEvent(request);
    }

    protected async virtual Task OnComponentEvent<TCommand>(CommandRequest<TCommand> request)
        where TCommand : ICommand
    {
        await Mediatr.Send(request);
    }

    protected virtual async Task<bool> OnStateChanged(object sender, TStateEvents stateEvent)
    {
        if(!ObserveableStateEvents.Contains(stateEvent))
            return false;

        ViewModel = await GetViewModelInternal();
        StateHasChanged();
        return true;
    }

    protected virtual Dictionary<string, object> GetParameters()
    {
        var eventCallback = EventCallback.Factory.Create<ICommand>(this, (command) => OnComponentEventInternal(Component, command));
        return new Dictionary<string, object>
            {
                { "ViewModel", ViewModel },
                { "GetViewModel", async () => await GetViewModelInternal() },
                { "OnComponentEvent", eventCallback }
            };
    }

    public void Dispose()
    {
        StateStore.StateChanged -= OnStateChanged;
    }
}