@using Carlton.Core.Foundation.State
@using Carlton.Core.Utilities.Extensions;
@namespace Carlton.Core.Flux.Debug.Components.Logging.EventLogging.LogTable

@* Component for displaying an event log table in a debug environment. *@
<div class="log-table">
    <Table Headings="Headings"
           Items="LogMessages"
           ShowPaginationRow="true"
           OrderColumn="@EventLogTableState.OrderByColum"
           OrderAscending="EventLogTableState.OrderAscending"
           CurrentPage="EventLogTableState.CurrentPage"
           SelectedRowsPerPageIndex="EventLogTableState.SelectedRowsPerPageOptsIndex"
           RowsPerPageOpts="EventLogTableState.RowsPerPageOpts"
           ZebraStripped="true"
           Hoverable="true"
           OnPageChange="OnPageChange"
           OnRowsPerPageChange="OnRowsPerPageChange"
           OnItemsSort="OnItemsSort">
        <RowTemplate Context="item">
            <EventLogTableRow LogEntry="item"
                              LogMessageSelected="OnLogMessageSelected"
                              IsSelected="item==SelectedLogMessage" />
        </RowTemplate>
    </Table>
</div>

@code {
	/// <summary>
	/// Gets or sets the list of log messages to display.
	/// </summary>
	[Parameter]
    public List<LogMessage> LogMessages { get; set; } = new();

	/// <summary>
	/// Gets or sets the index of the selected log message.
	/// </summary>
	[Parameter]
    public int SelectedLogMessageIndex { get; set; }

	/// <summary>
	/// Gets or sets the state of the event log table.
	/// </summary>
	[Parameter]
    public required TableState EventLogTableState { get; set; }

	/// <summary>
	/// Event callback for when a log message is selected.
	/// </summary>
	[Parameter]
    public EventCallback<SelectedEventLogMessageChangedArgs> LogMessageSelected { get; set; }

	/// <summary>
	/// Event callback for page change.
	/// </summary>
	[Parameter]
    public EventCallback<PageChangeEventArgs> OnPageChange { get; set; }

	/// <summary>
	/// Event callback for rows per page change.
	/// </summary>
	[Parameter]
    public EventCallback<RowsPerPageChangeEventArgs> OnRowsPerPageChange { get; set; }


	/// <summary>
	/// Event callback for sorting items.
	/// </summary>
	[Parameter]
    public EventCallback<ItemsSortEventArgs> OnItemsSort { get; set; }

    private LogMessage? SelectedLogMessage => LogMessages.SafeGetAtIndex(SelectedLogMessageIndex);

    private void OnLogMessageSelected(LogMessage selectedLogMessage)
    {
        var index = LogMessages.FindIndex(_ => _ == selectedLogMessage);
        SelectedLogMessageIndex = index;
        var args = new SelectedEventLogMessageChangedArgs(index);
        LogMessageSelected.InvokeAsync(args);
    }

    private IEnumerable<TableHeadingItem> Headings
    {
        get => new List<TableHeadingItem>
        {
            new TableHeadingItem("Timestamp"),
            new TableHeadingItem("Message"),
            new TableHeadingItem("Log Level", "LogLevel"),
            new TableHeadingItem("Event ID", "EventId.Id"),
            new TableHeadingItem("Event Name", "EventId.Name"),
        };
    }
}
