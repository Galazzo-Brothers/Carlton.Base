@namespace Carlton.Core.Components.Lab.Components.ConnectedComponents
@attribute [ObserveStateEvents("MenuItemSelected")]
@attribute [ObserveStateEvents("MenuItemExpandedStateChanged")]
@inherits BaseConnectedComponent<NavMenuViewModel>


<AccordionSelectGroup TValue="ComponentState"
                      Groups="ComponentStateGroups"
                      SelectedItem="SelectedComponentState"
                      OnExpandedStateChanged="args => base.OnComponentEvent.InvokeAsync(new SelectMenuExpandedCommand(args.GroupIndexID, args.IsExpanded))"
                      OnSelectedItemChanged="args => base.OnComponentEvent.InvokeAsync(new SelectMenuItemCommand(args.GroupIndexID, args.ItemIndexID, args.Item))" />


@code{
    private IEnumerable<SelectGroup<ComponentState>> ComponentStateGroups { get; set; }

    private ComponentState SelectedComponentState 
    {
        get => ViewModel.MenuItems
                        .ElementAt(ViewModel.SelectedComponentIndex)
                        .ComponentStates
                        .ElementAt(ViewModel.SelectedStateIndex);
    }

    protected override void OnParametersSet()
    {
        ParseComponentStatesIntoAccordionGroups();
        base.OnParametersSet();
    }

    private void ParseComponentStatesIntoAccordionGroups()
    {
        var components = ViewModel.MenuItems;

        var builder = new AccordionSelectGroupBuilder<ComponentState>();

        foreach(var component in components)
        {            
            var dictionary = component.ComponentStates
                                      .ToDictionary(_ => _.DisplayName, _ => _);    
            builder.AddGroup(component.ComponentType.GetDisplayName(), component.IsExpanded, dictionary);
        }

        ComponentStateGroups = builder.Build();
    }
}