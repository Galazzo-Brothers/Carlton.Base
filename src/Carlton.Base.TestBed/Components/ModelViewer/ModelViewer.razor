@namespace Carlton.Base.TestBed
@attribute [DataEndpointRefreshPolicy(DataEndpointRefreshPolicy.Never)]
@attribute [ObserveStateEvents<TestBedStateEvents>(TestBedStateEvents.ComponentStateSelected)]
@attribute [ObserveStateEvents<TestBedStateEvents>(TestBedStateEvents.ParametersChanged)]
@inherits DataComponentBase<ModelViewerViewModel>

<div class="view-model-viewer">
    <div class="form-group">
        <Console Text="@ViewModelJson"
                 IsReadOnly="false"
                 IsValid="@IsValid"
                 OnChangeCallback="OnViewModelChanged" />
    </div>
</div>


@code {
    private bool IsValid { get; set; } = true;
    private string ViewModelJson { get; set; } = string.Empty;

    protected override void OnParametersSet()
    {
        IsValid = true;
        ViewModelJson =  JsonSerializer.Serialize(ViewModel.ComponentParameters.ParameterObj, new JsonSerializerOptions { WriteIndented = true });
        base.OnParametersSet();
    }

    private async Task OnViewModelChanged(string vmStr)
    {
        try
        {
            //Parse New ViewModel String
            var type = ViewModel.ComponentParameters.ParameterObj.GetType();
            var deserializedViewModel = JsonSerializer.Deserialize(vmStr, type);
            IsValid = true;
            
            //If Parse succeeds Send ComponentEvent
            var paramObjType = ViewModel.ComponentParameters.ParameterObjType;
            var componentParameters = new ComponentParameters(deserializedViewModel, paramObjType);
            await base.OnComponentEvent.InvokeAsync(new ModelChangedCommand(componentParameters));
        }
        catch(Exception)
        {
            IsValid = false;
        }
    }
}
