@using Carlton.Core.Components.Layouts.Extensions
@using Carlton.Core.Components.Layouts.Panel
@using Carlton.Core.Components.Layouts.Theme
@using Carlton.Core.Components.Modals
@using Carlton.Core.Components.Toasts
@using Carlton.Core.Components.Layouts.Toasts
@using Carlton.Core.Components.Layouts.FullScreen
@using Carlton.Core.Components.Layouts.Modals
@namespace Carlton.Core.Components.Layouts.Manager
@inherits LayoutComponentBase
@implements IDisposable
@inject IFullScreenState NavMenuState
@inject IThemeState ThemeState
@inject IModalState ModalState
@inject IToastState ToastState
@inject IPanelState PanelState


@* This component manages the layout of the application including modals and toasts. *@
<div class="layout-manager" data-theme="@ThemeState.Theme.ToString()">
    <!-- Body Content -->
    @Body

    <!--Layout Toaster-->
    <LayoutToaster @ref="LayoutToaster"
                   FadeOutEnabled="true"
                   Top="50"
                   Right="10" />

    <!--Layout Modal-->
    <Modal IsVisible="ModalState.IsVisible"
           ModalType="ModalState.ModalType"
           ModalPrompt="@ModalState?.Model?.Prompt"
           ModalMessage="@ModalState?.Model?.Message"
           CloseModal="CloseModalOrDefault"
           DismissModal="DismissModalOrDefault" />
</div>


@code {

	[Parameter]
	public RenderFragment<IModalState> ModalContent { get; set; }

    private LayoutToaster LayoutToaster { get; set; }

    protected override void OnInitialized()
    {
        NavMenuState.FullScreenStateChanged += OnLayoutChanged;
        ThemeState.ThemeChanged += OnThemeChanged;
        ModalState.ModalStateChanged += OnModalStateChanged;
        PanelState.PanelVisibilityChangedChanged += OnPanelVisibilityChanged;
        ToastState.ToastAdded += OnToastRaised;
        base.OnInitialized();
    }

    private void OnLayoutChanged(object? sender, FullScreenStateChangedEventArgs args)
        => StateHasChanged();

    private void OnThemeChanged(object? sender, ThemeChangedEventArgs args)
        => StateHasChanged();

    private void OnModalStateChanged(object? sender, ModalStateChangedEventArgs args)
        => StateHasChanged();

    private void OnPanelVisibilityChanged(object? sender, PanelVisibilityChangedEventArgs args)
       => StateHasChanged();

    private void OnToastRaised(object? sender, ToastRaisedEventArgs args)
        => LayoutToaster.GenerateToast(args.RaisedToast);

    private Func<ModalCloseEventArgs, Task> CloseModalOrDefault
    {
        get
        {
            if (ModalState == null || ModalState.Model == null || ModalState.Model.CloseModal == null)
                return (args) => Task.CompletedTask;

            return ModalState.Model.CloseModal;
        }
    }

    private Func<Task> DismissModalOrDefault
    {
        get
        {
            if (ModalState == null || ModalState.Model == null || ModalState.Model.DismissModal == null)
                return () => Task.CompletedTask;

            return ModalState.Model.DismissModal;
        }
    }

    public void Dispose()
    {
        NavMenuState.FullScreenStateChanged -= OnLayoutChanged;
        ThemeState.ThemeChanged -= OnThemeChanged;
        ModalState.ModalStateChanged -= OnModalStateChanged;
        PanelState.PanelVisibilityChangedChanged -= OnPanelVisibilityChanged;
        ToastState.ToastAdded -= OnToastRaised;
    }
}