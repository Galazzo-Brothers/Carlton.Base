@using Carlton.Core.Components.Select
@namespace Carlton.Core.Components.Table
@typeparam TItem


<div class="pagination-row">
    <div class="rows-per-page">
        <span class="rows-per-page-label">Rows Per Page</span>
        <Dropdown Options="RowsPerPageSelectOpts" SelectedValue="SelectedRowsPerPageValue" ValueChangedCallback="(rpp) => ChangeRowsPerPage(rpp.SelectedIndex)" />
    </div>
    <div class="page-number">
        <span class="pagination-label">@PaginationLabel</span>
    </div>
    <div class="page-chevrons">
        <span class="@PageFirstChevronCss" @onclick="() => ChangePage(1)"></span>
        <span class="@PageLeftChevronCss" @onclick="() => ChangePage(CurrentPage-1)"></span>
        <span class="@PageRightChevronCss" @onclick="() => ChangePage(CurrentPage+1)"></span>
        <span class="@PageLastChevronCss" @onclick="() => ChangePage(MaxPage)"></span>
    </div>
</div>

@code {

    [Parameter]
    public IEnumerable<int> RowsPerPageOpts { get; set; }

    [Parameter]
    public int TotalItemCount { get; set; }

    [Parameter]
    public int CurrentPage { get; set; } = 1;

    [Parameter]
    public int SelectedRowsPerPageIndex { get; set; }

    [Parameter]
    public EventCallback<TablePageChangedArgs> PageChanged { get; set; }

    [Parameter]
    public EventCallback<TableRowsPerPageChangedArgs> RowsPerPageChanged { get; set; }

    public int SelectedRowsPerPageValue { get => RowsPerPageOpts.ElementAt(SelectedRowsPerPageIndex); }

    private IReadOnlyDictionary<string, int> RowsPerPageSelectOpts { get; set; }

    private int MaxPage { get => Math.Max(1, (int)Math.Ceiling((decimal)TotalItemCount / SelectedRowsPerPageValue)); }

    private string PaginationLabel 
    {
        get  
        {
            var paginationCurrentRangeStart = 1 + ((CurrentPage - 1) * SelectedRowsPerPageValue);
            var paginationCurrentRangeEnd = Math.Min(CurrentPage * SelectedRowsPerPageValue, TotalItemCount);
            return $"{paginationCurrentRangeStart}-{paginationCurrentRangeEnd} of {TotalItemCount}";
        }
    }

    protected override void OnInitialized()
    {
        if (SelectedRowsPerPageIndex < 0)
            throw new ArgumentException("Selected index cannot be less than 0.");

        if (SelectedRowsPerPageIndex > RowsPerPageOpts.Count())
            throw new ArgumentException("Selected index cannot be greater than RowsPerPageOpts count.");

        if (CurrentPage > MaxPage)
            throw new ArgumentException("Current page cannot be greater than the max page.");

        RowsPerPageSelectOpts = RowsPerPageOpts.ToDictionary(_ => _.ToString(), _ => _);
        base.OnInitialized();
    }

    private async Task ChangePage(int newPageNumber)
        => await PageChanged.InvokeAsync(new TablePageChangedArgs(newPageNumber));
    

    private async Task ChangeRowsPerPage(int rowsPerPageIndex)
        => await RowsPerPageChanged.InvokeAsync(new TableRowsPerPageChangedArgs(rowsPerPageIndex));
    

    private string PageFirstChevronCss
    {
        get => new CssBuilder()
             .AddClass("mdi")
             .AddClass("mdi-18px")
             .AddClass("mdi-page-first")
             .AddClass("disabled", CurrentPage == 1)
             .Build();
    }

    private string PageLeftChevronCss
    {
        get => new CssBuilder()
            .AddClass("mdi")
            .AddClass("mdi-18px")
            .AddClass("mdi-chevron-left")
            .AddClass("disabled", CurrentPage == 1)
            .Build();
    }

    private string PageRightChevronCss
    {
        get => new CssBuilder()
            .AddClass("mdi")
            .AddClass("mdi-18px")
            .AddClass("mdi-chevron-right")
            .AddClass("disabled", CurrentPage == MaxPage)
            .Build();
    }

    private string PageLastChevronCss
    {
        get => new CssBuilder()
            .AddClass("mdi")
            .AddClass("mdi-18px")
            .AddClass("mdi-page-last")
            .AddClass("disabled", CurrentPage == MaxPage)
            .Build();
    }
}
